{"identifier":{"url":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/Hummingbird\/Sessions","interfaceLanguage":"swift"},"metadata":{"roleHeading":"Article","modules":[{"name":"HummingbirdAuth"}],"role":"article","title":"Sessions"},"hierarchy":{"paths":[["doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth"]]},"sections":[],"schemaVersion":{"patch":0,"major":0,"minor":3},"primaryContentSections":[{"content":[{"anchor":"overview","type":"heading","level":2,"text":"Overview"},{"inlineContent":[{"type":"text","text":"Sessions allow you to persist user data between multiple requests to the server. They work by creating a temporary session object that is stored in a key\/value store. The key or session id is returned in the response. Subsequent requests can then access the session object by supplying the session id in their request. This object can then be used to authenicate the user. Normally the session id is stored in a cookie."}],"type":"paragraph"},{"anchor":"Setup","type":"heading","level":2,"text":"Setup"},{"type":"paragraph","inlineContent":[{"text":"Before you can use sessions you need to add them to the application. When adding them you choose where you want to store the session key\/value store. HummingbirdAuth only provides the option to store it memory, but if you include the ","type":"text"},{"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdFluent","isActive":true,"type":"reference"},{"text":" or ","type":"text"},{"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdRedis","isActive":true,"type":"reference"},{"text":" packages you can store it in a fluent or redis database.","type":"text"}]},{"type":"codeListing","syntax":"swift","code":["app.addSessions(using: .memory)"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"If you donâ€™t provide a "},{"type":"codeVoice","code":"using"},{"type":"text","text":" parameter and you have already called "},{"type":"codeVoice","code":"\/Hummingbird\/HBApplication\/addPersist(using:)"},{"type":"text","text":" to setup the persist framework, sessions will use the same storage method as persist."}]},{"type":"paragraph","inlineContent":[{"text":"By default sessions store the session id in a ","type":"text"},{"type":"codeVoice","code":"SESSION_ID"},{"text":" cookie. At initialisation it is possible to set it up to use a different cookie.","type":"text"}]},{"code":["app.addSessions(using: .memory, sessionID: .cookie(\"MY_SESSION_ID\"))"],"type":"codeListing","syntax":"swift"},{"type":"paragraph","inlineContent":[{"type":"text","text":"It is also possible to set it up to use a header instead"}]},{"code":["app.addSessions(using: .memory, sessionID: .header(\"SESSION_ID\"))"],"type":"codeListing","syntax":"swift"},{"level":2,"anchor":"Saving-a-session","type":"heading","text":"Saving a session"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Once a user is authenticated you need to save a session for the user."}]},{"code":["func login(_ request: HBRequest) async throws -> HTTPResponseStatus {","    \/\/ get authenticated user","    guard let user = request.authGet(User.self),","            let userId = user.id else { return request.failure(.unauthorized) }","    \/\/ create session lasting 1 hour","    try await request.session.save(session: userId, expiresIn: .minutes(60))","    return .ok","}"],"type":"codeListing","syntax":"swift"},{"type":"paragraph","inlineContent":[{"text":"In this example the ","type":"text"},{"type":"codeVoice","code":"userId"},{"text":" is saved with the session id. When you call ","type":"text"},{"type":"codeVoice","code":"session.save"},{"text":" it either adds a session id cookie or header to the response, depending on what you set up in ","type":"text"},{"type":"codeVoice","code":"addSessions"},{"text":". Because the response is being edited you need to add the option ","type":"text"},{"type":"codeVoice","code":".editResponse"},{"text":" when adding this method to the router eg","type":"text"}]},{"code":["app.router.post(options: .editResponse, use: login)"],"type":"codeListing","syntax":"swift"},{"level":2,"anchor":"Sessions-Authentication","type":"heading","text":"Sessions Authentication"},{"type":"paragraph","inlineContent":[{"type":"text","text":"To authenticate a user using a session id you need to add a session authenticator to the application. This extracts the session id from the request, gets the associated value for the session id from the key\/value store and then converts this associated value into the authenticated user. Most of this work is done for you, but the conversion from session object to user most be provided by the application. To do this create an authenticator middleware that conforms to either "},{"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/HBSessionAuthenticator","type":"reference","isActive":true},{"type":"text","text":" or "},{"type":"codeVoice","code":"HummingbirdAuth\/HBAsyncSessionAuthenticator"},{"type":"text","text":" and override the "},{"type":"codeVoice","code":"getValue"},{"type":"text","text":" function."}]},{"code":["struct MySessionAuthenticator: HBAsyncSessionAuthenticator {","    \/\/\/ session object","    typealias Session = UUID","    \/\/\/ authenticated user","    typealias Value = User","","    \/\/\/ convert from session object to authenticated user","    func getValue(from session: Session, request: Hummingbird.HBRequest) async throws -> Value? {","        return try await User.find(session, on: request.db)","    }","}"],"type":"codeListing","syntax":"swift"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Add the authenticator as middleware to the routes you want to enable session authentication for"}]},{"code":["application.router.group()","    .add(middleware: MySessionAuthenticator())","    .get(\"session\") { request -> HTTPResponseStatus in","        _ = try request.authRequire(User.self)","        return .ok","    }"],"type":"codeListing","syntax":"swift"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Your route will be able to access the authenticated user via "},{"code":"request.authRequire","type":"codeVoice"},{"type":"text","text":" or "},{"code":"request.authGet","type":"codeVoice"},{"type":"text","text":"."}]}],"kind":"content"}],"kind":"article","abstract":[{"type":"text","text":"Session based authentication"}],"seeAlsoSections":[{"generated":true,"title":"Articles","identifiers":["doc:\/\/com.opticalaberration.hummingbird\/documentation\/Hummingbird\/Authenticators","doc:\/\/com.opticalaberration.hummingbird\/documentation\/Hummingbird\/OneTimePasswords"]}],"references":{"doc://com.opticalaberration.hummingbird/documentation/Hummingbird/Authenticators":{"url":"\/documentation\/hummingbird\/authenticators","type":"topic","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/Hummingbird\/Authenticators","role":"article","title":"Authenticators","kind":"article","abstract":[{"type":"text","text":"Request authentication middleware"}]},"doc://com.opticalaberration.hummingbird/documentation/HummingbirdAuth/HBSessionAuthenticator":{"role":"symbol","fragments":[{"text":"protocol","kind":"keyword"},{"text":" ","kind":"text"},{"kind":"identifier","text":"HBSessionAuthenticator"}],"type":"topic","kind":"symbol","url":"\/documentation\/hummingbirdauth\/hbsessionauthenticator","navigatorTitle":[{"text":"HBSessionAuthenticator","kind":"identifier"}],"abstract":[{"text":"Session authenticator","type":"text"}],"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/HBSessionAuthenticator","title":"HBSessionAuthenticator"},"doc://com.opticalaberration.hummingbird/documentation/HummingbirdAuth":{"role":"collection","abstract":[{"text":"Authentication framework and extensions for Hummingbird.","type":"text"}],"url":"\/documentation\/hummingbirdauth","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth","title":"HummingbirdAuth","type":"topic","kind":"symbol"},"doc://com.opticalaberration.hummingbird/documentation/HummingbirdRedis":{"url":"\/documentation\/hummingbirdredis","type":"topic","abstract":[{"text":"Add Redis support to Hummingbird server with RediStack.","type":"text"}],"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdRedis","role":"collection","kind":"symbol","title":"HummingbirdRedis"},"doc://com.opticalaberration.hummingbird/documentation/HummingbirdFluent":{"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdFluent","type":"topic","kind":"symbol","role":"collection","abstract":[{"text":"Integration with Vapor Fluent ORM framework.","type":"text"}],"title":"HummingbirdFluent","url":"\/documentation\/hummingbirdfluent"},"doc://com.opticalaberration.hummingbird/documentation/Hummingbird/OneTimePasswords":{"url":"\/documentation\/hummingbird\/onetimepasswords","type":"topic","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/Hummingbird\/OneTimePasswords","role":"article","title":"One Time Passwords","kind":"article","abstract":[{"type":"text","text":"A one time password (OTP) valid for only one login session."}]}}}