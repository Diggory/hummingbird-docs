{"kind":"article","seeAlsoSections":[{"title":"Articles","identifiers":["doc:\/\/com.opticalaberration.hummingbird\/documentation\/Hummingbird\/AuthenticatorMiddleware","doc:\/\/com.opticalaberration.hummingbird\/documentation\/Hummingbird\/OneTimePasswords"],"generated":true}],"abstract":[{"type":"text","text":"Session based authentication"}],"schemaVersion":{"major":0,"patch":0,"minor":3},"topicSections":[{"title":"Reference","identifiers":["doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/SessionStorage","doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/SessionMiddleware"]}],"sections":[],"primaryContentSections":[{"kind":"content","content":[{"anchor":"overview","type":"heading","level":2,"text":"Overview"},{"inlineContent":[{"text":"Sessions allow you to persist user authentication data between multiple requests to the server. They work by creating a temporary session object that is stored in a key\/value store. The key or session id is returned in the response. Subsequent requests can then access the session object by supplying the session id in their request. This object can then be used to authenicate the user. Normally the session id is stored in a cookie.","type":"text"}],"type":"paragraph"},{"anchor":"Setup","type":"heading","level":2,"text":"Setup"},{"inlineContent":[{"text":"Before you can use sessions you need a ","type":"text"},{"type":"reference","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/SessionStorage","isActive":true},{"text":" to store your session data and a persist key value store. You can find out more about the persist framework here <doc: PersistentData>. In the example below we are using an in memory key value store, but ","type":"text"},{"type":"reference","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdFluent\/FluentPersistDriver","isActive":true},{"text":" and ","type":"text"},{"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdRedis\/RedisPersistDriver","type":"reference","isActive":true},{"type":"text","text":" provide solutions that stores the session data in a database or redis database respectively."}],"type":"paragraph"},{"type":"codeListing","code":["let persist = MemoryPersistDriver()","let sessions = SessionStorage(persist)"],"syntax":"swift"},{"inlineContent":[{"type":"text","text":"By default sessions store the session id in a "},{"type":"codeVoice","code":"SESSION_ID"},{"type":"text","text":" cookie. At initialisation it is possible to set it up to use a different cookie."}],"type":"paragraph"},{"type":"codeListing","code":["app.addSessions(using: .memory, sessionID: .cookie(\"MY_SESSION_ID\"))"],"syntax":"swift"},{"anchor":"Saving-a-session","type":"heading","level":2,"text":"Saving a session"},{"inlineContent":[{"text":"Once a user is authenticated you need to save a session for the user.","type":"text"}],"type":"paragraph"},{"type":"codeListing","code":["func login(_ request: Request) async throws -> HTTPResponseStatus {","    \/\/ get authenticated user","    let user = try context.auth.require(User.self)","    guard let userId = user.id else { return request.failure(.unauthorized) }","    \/\/ create session lasting 1 hour","    let cookie = try await request.session.save(session: userId, expiresIn: .minutes(60))","    let response = Response(status: .ok)","    response.setCookie(cookie)","    return response","}"],"syntax":"swift"},{"inlineContent":[{"text":"In this example the ","type":"text"},{"type":"codeVoice","code":"userId"},{"text":" is saved with the session id. When you call ","type":"text"},{"type":"codeVoice","code":"session.save"},{"text":" it returns a cookie to be returned in your response.","type":"text"}],"type":"paragraph"},{"anchor":"Sessions-Authentication","type":"heading","level":2,"text":"Sessions Authentication"},{"inlineContent":[{"text":"To authenticate a user using a session id you need to add a session authenticator to the application. This extracts the session id from the request, gets the associated value for the session id from the key\/value store and then converts this associated value into the authenticated user. Most of this work is done for you, but the conversion from session object to user most be provided by the application. To do this create an authenticator middleware that conforms to  ","type":"text"},{"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/SessionMiddleware","type":"reference","isActive":true},{"text":" and implement the ","type":"text"},{"code":"getValue","type":"codeVoice"},{"text":" function and provide a reference to a ","type":"text"},{"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/SessionStorage","type":"reference","isActive":true},{"text":" object.","type":"text"}],"type":"paragraph"},{"type":"codeListing","code":["struct MySessionAuthenticator<Context: AuthRequestContext>: SessionMiddleware {","    \/\/\/ requirement, where to get session data from","    let sessionStorage: SessionStorage","    func getValue(from session: UUID, request: Request, context: Context) async throws -> User? {","        return try await getUserFromDatabase(id: session)","    }","}"],"syntax":"swift"},{"inlineContent":[{"text":"Add the authenticator as middleware to the routes you want to enable session authentication for. As with all authenticators your request context will need to conform to ","type":"text"},{"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/AuthRequestContext","isActive":true,"type":"reference"},{"text":".","type":"text"}],"type":"paragraph"},{"type":"codeListing","code":["router.group()","    .add(middleware: MySessionAuthenticator())","    .get(\"session\") { request, context -> HTTPResponse.Status in","        _ = try context.auth.require(User.self)","        return .ok","    }"],"syntax":"swift"},{"inlineContent":[{"text":"Your route will be able to access the authenticated user via ","type":"text"},{"type":"codeVoice","code":"context.auth.require"},{"text":" or ","type":"text"},{"type":"codeVoice","code":"context.auth.get"},{"text":".","type":"text"}],"type":"paragraph"}]}],"metadata":{"title":"Sessions","modules":[{"name":"HummingbirdAuth"}],"role":"collectionGroup"},"identifier":{"interfaceLanguage":"swift","url":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/Hummingbird\/Sessions"},"hierarchy":{"paths":[["doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth"],["doc:\/\/com.opticalaberration.hummingbird\/documentation\/index"]]},"references":{"doc://com.opticalaberration.hummingbird/documentation/HummingbirdRedis/RedisPersistDriver":{"kind":"symbol","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdRedis\/RedisPersistDriver","abstract":[{"type":"text","text":"Redis driver for persist system for storing persistent cross request key\/value pairs"}],"type":"topic","navigatorTitle":[{"kind":"identifier","text":"RedisPersistDriver"}],"title":"RedisPersistDriver","url":"\/documentation\/hummingbirdredis\/redispersistdriver","fragments":[{"kind":"keyword","text":"struct"},{"kind":"text","text":" "},{"kind":"identifier","text":"RedisPersistDriver"}],"role":"symbol"},"doc://com.opticalaberration.hummingbird/documentation/HummingbirdAuth":{"role":"collection","abstract":[{"type":"text","text":"Authentication framework and extensions for Hummingbird."}],"kind":"symbol","title":"HummingbirdAuth","type":"topic","url":"\/documentation\/hummingbirdauth","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth"},"doc://com.opticalaberration.hummingbird/documentation/HummingbirdAuth/AuthRequestContext":{"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/AuthRequestContext","type":"topic","title":"AuthRequestContext","abstract":[{"type":"text","text":"Protocol that all request contexts should conform to if they want to support"},{"text":" ","type":"text"},{"text":"authentication middleware","type":"text"}],"url":"\/documentation\/hummingbirdauth\/authrequestcontext","role":"symbol","kind":"symbol","fragments":[{"kind":"keyword","text":"protocol"},{"kind":"text","text":" "},{"kind":"identifier","text":"AuthRequestContext"}],"navigatorTitle":[{"kind":"identifier","text":"AuthRequestContext"}]},"doc://com.opticalaberration.hummingbird/documentation/HummingbirdAuth/SessionStorage":{"kind":"symbol","title":"SessionStorage","url":"\/documentation\/hummingbirdauth\/sessionstorage","abstract":[{"type":"text","text":"Stores session data"}],"type":"topic","navigatorTitle":[{"kind":"identifier","text":"SessionStorage"}],"role":"symbol","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/SessionStorage","fragments":[{"kind":"keyword","text":"struct"},{"kind":"text","text":" "},{"kind":"identifier","text":"SessionStorage"}]},"doc://com.opticalaberration.hummingbird/documentation/index":{"kind":"article","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/index","url":"\/documentation\/index","abstract":[{"type":"text","text":"Lightweight, flexible, modern server framework written in Swift."}],"role":"collection","type":"topic","title":"Hummingbird"},"doc://com.opticalaberration.hummingbird/documentation/Hummingbird/OneTimePasswords":{"kind":"article","title":"One Time Passwords","url":"\/documentation\/hummingbird\/onetimepasswords","abstract":[{"type":"text","text":"A one time password (OTP) valid for only one login session."}],"type":"topic","role":"collectionGroup","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/Hummingbird\/OneTimePasswords"},"doc://com.opticalaberration.hummingbird/documentation/Hummingbird/AuthenticatorMiddleware":{"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/Hummingbird\/AuthenticatorMiddleware","abstract":[{"type":"text","text":"Request authentication middleware"}],"kind":"article","type":"topic","title":"Authenticator Middleware","url":"\/documentation\/hummingbird\/authenticatormiddleware","role":"collectionGroup"},"doc://com.opticalaberration.hummingbird/documentation/HummingbirdFluent/FluentPersistDriver":{"kind":"symbol","title":"FluentPersistDriver","url":"\/documentation\/hummingbirdfluent\/fluentpersistdriver","abstract":[{"type":"text","text":"Fluent driver for persist system for storing persistent cross request key\/value pairs"}],"type":"topic","navigatorTitle":[{"kind":"identifier","text":"FluentPersistDriver"}],"role":"symbol","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdFluent\/FluentPersistDriver","fragments":[{"kind":"keyword","text":"class"},{"kind":"text","text":" "},{"kind":"identifier","text":"FluentPersistDriver"}]},"doc://com.opticalaberration.hummingbird/documentation/HummingbirdAuth/SessionMiddleware":{"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/SessionMiddleware","abstract":[{"text":"Session authenticator","type":"text"}],"fragments":[{"kind":"keyword","text":"protocol"},{"kind":"text","text":" "},{"kind":"identifier","text":"SessionMiddleware"}],"title":"SessionMiddleware","kind":"symbol","url":"\/documentation\/hummingbirdauth\/sessionmiddleware","role":"symbol","navigatorTitle":[{"kind":"identifier","text":"SessionMiddleware"}],"type":"topic"}}}